# Keystore2 bootloop prevention service
# This service monitors and prevents Keystore2 from continuously restarting

service keystore2_monitor /system/bin/sh -c "
    # Wait for system to stabilize
    sleep 5
    
    # Check if keystore2 is running and causing issues
    if pgrep keystore2 > /dev/null; then
        # If keystore2 is consuming too much CPU or memory, kill it
        cpu_usage=\$(top -n 1 -p \$(pgrep keystore2) | tail -1 | awk '{print \$9}' | cut -d'%' -f1)
        if [ \"\$cpu_usage\" -gt 80 ]; then
            echo 'Keystore2 high CPU usage detected, stopping service'
            killall keystore2
            setprop ctl.stop keystore2
        fi
    fi
    
    # Prevent rapid restarts
    setprop vendor.keystore.boot_level 1
"
    class late_start
    user root
    group root
    oneshot
    disabled
    seclabel u:r:recovery:s0

# Start the monitor after crypto is ready
on property:crypto.ready=1
    start keystore2_monitor